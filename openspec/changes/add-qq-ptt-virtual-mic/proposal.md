# 变更提案：add-qq-ptt-virtual-mic

## 背景与动机

QQ 语音缺少原生按键通话能力，导致游戏场景下无法快速门控麦克风，容易引发背景噪声泄漏。

## 目标与范围

- 提供物理麦克风到虚拟麦克风的桥接能力。
- 提供全局快捷键门控，支持 PTT / Toggle / Hybrid。
- 提供托盘常驻与最小化到托盘。
- 提供首启引导和运行时诊断。

## 非目标

- 不实现虚拟声卡驱动本体。
- 不实现高级音频处理（AEC/NS/AGC）。
- 不实现云同步/账号体系。

## 与现有规范关系

- 当前无既有功能规范，本提案新增 `mic-gating` 规范。

## 主要方案

- 音频：使用 CPAL (WASAPI) 建立输入输出流，环形缓冲桥接。
- 门控：共享状态机控制输出流是否写入音频帧，闭麦输出静音帧。
- 快捷键：Tauri global-shortcut 插件监听按下/释放事件。
- 托盘：Tauri tray 动态菜单提供开关麦与主窗口控制。
- 配置：本地 JSON/TOML 持久化，支持默认值回退。

## 安全/权限/隐私

- 本地处理音频，不上传网络。
- 仅申请全局快捷键与自启动所需权限。

## 兼容性与回滚

- 向后兼容配置字段，新增字段给默认值。
- 构建失败或运行异常可回退到上一安装版本。

## 风险与缓解

1. 设备采样率不匹配：优先匹配共同采样率，不匹配时提示用户调整。
2. 快捷键冲突：注册失败后提示用户改键。
3. 设备热插拔：流错误时切换到 Error 状态并允许重启引擎。

## 决策记录（Decisions）

- 默认采用保守策略：错误显式抛出并日志记录。
- 默认向后兼容配置结构。
- 默认为关键路径补齐测试。

## 澄清问题清单

### 阻断级

- 无（用户已确认关键决策）。

### 非阻断级

- 是否首版支持多语言：默认仅中文界面，后续扩展。
- 是否支持多路输出：默认单路输出，后续扩展。
