# 任务拆解：rework-hotkey-and-virtual-mic

## 0. 先决任务（阻断）

- 任务目标：锁定方案 A/B 与签名能力边界。
- 影响范围：`openspec/changes/rework-hotkey-and-virtual-mic/*`
- 实施要点：明确是否进入驱动开发路径。
- 验收标准：阻断问题全部闭合并记录到 proposal 决策区。
- 验证方法：评审记录。
- 回滚方式：停留在规范阶段，不进入实现。

## 1. 快捷键录入改造（UI + 后端）

- 任务目标：将字符串输入改为按键录入捕获。
- 影响范围：`src/App.tsx`、`src/components/*`、`src-tauri/src/hotkey.rs`
- 实施要点：键盘事件录入、冲突提示、注册回滚。
- 验收标准：用户可按下组合键完成录入并生效。
- 验证方法：手动场景 + 单测。
- 回滚方式：回退到字符串输入。

## 2. 启动自动初始化与状态提示

- 任务目标：应用启动后自动初始化语音链路与状态。
- 影响范围：`src-tauri/src/lib.rs`、`src-tauri/src/app_state.rs`、`src/App.tsx`
- 实施要点：冷启动检测、失败显式提示、托盘状态同步。
- 验收标准：首次启动无需手动点“启动”即可进入可用/可诊断状态。
- 验证方法：冷启动回归、日志检查。
- 回滚方式：恢复手动启动开关。

## 3. UI 简化与文案调整

- 任务目标：仅保留物理麦输入选择，移除“立即开麦/闭麦”文案。
- 影响范围：`src/App.tsx`、`src/lib/types.ts`
- 实施要点：保留模式切换与状态展示，移除桥接输出选择 UI。
- 验收标准：页面中不出现桥接输出配置与“立即开麦/闭麦”文案。
- 验证方法：界面走查与快照。
- 回滚方式：恢复双设备配置界面。

## 4A.（方案 A）虚拟麦驱动与用户态服务

- 任务目标：应用自身提供可识别的虚拟麦克风端点。
- 影响范围：`driver/*`（新目录）、`src-tauri/src/audio/*`、安装脚本
- 实施要点：
  - 驱动端点暴露（Capture Endpoint）
  - 用户态音频写入接口（共享内存/IOCTL）
  - 门控状态映射
- 验收标准：QQ 可直接选择“本应用虚拟麦克风”。
- 验证方法：Windows 实机验收 + 稳定性测试。
- 回滚方式：卸载驱动并恢复旧版本。

## 4B.（方案 B）外部虚拟声卡兼容路径（仅兜底）

- 任务目标：若 A 被否决/受阻，提供快速可用版本。
- 影响范围：现有 `audio.rs` 与 UI 简化改造。
- 实施要点：保留桥接内核，但隐藏输出配置细节。
- 验收标准：用户仅选物理输入也可工作。
- 验证方法：QQ 语音实测。
- 回滚方式：恢复当前版本。

## 5. 发布与回滚策略补充

- 任务目标：完善驱动或发布流程相关文档与回滚手册。
- 影响范围：`README.md`、`docs/*`（如新增）
- 实施要点：写清管理员权限、签名要求、卸载步骤。
- 验收标准：按文档可完成安装、升级、回滚。
- 验证方法：文档走查 + 一次演练。
- 回滚方式：恢复前版文档。


## 6. 可观测性与故障诊断

- 任务目标：补齐驱动态/用户态链路的日志与健康指标。
- 影响范围：`src-tauri/src/*`、`driver/*`（若采用方案 A）
- 实施要点：统一请求/会话 ID、初始化耗时、设备状态、错误码映射。
- 验收标准：出现初始化失败、驱动异常、快捷键冲突时可快速定位。
- 验证方法：注入故障演练（设备断开、驱动不可用、按键冲突）。
- 回滚方式：仅降低日志级别，不影响主流程。

## 实施进度（2026-02-10）

- [x] 1. 快捷键录入改造（UI + 后端）
- [x] 2. 启动自动初始化与状态提示
- [x] 3. UI 简化与文案调整
- [x] 4A. 虚拟麦驱动与用户态服务（已完成工程骨架与协议草案）
- [ ] 4A. 虚拟麦驱动与用户态服务（真实可识别端点实现）
- [ ] 5. 发布与回滚策略补充
- [ ] 6. 可观测性与故障诊断（驱动态专项）

## 增量任务（2026-02-11）

### 7. 方案 A 决策落板与状态修正

- 任务目标：确保系统状态展示与真实驱动可用性一致，不再误报“已就绪”。
- 影响范围：`src-tauri/src/virtual_mic.rs`、`src/App.tsx`
- 实施要点：用真实设备检测结果驱动 `VirtualMicStatus.ready`。
- 验收标准：未安装驱动时明确显示“未就绪”；安装后显示“就绪”。
- 验证方法：本地枚举设备模拟 + UI 状态检查。
- 回滚方式：回退到固定文案。

### 8. Windows 驱动工程骨架增强

- 任务目标：补齐可落地驱动开发最小目录与安装脚本占位。
- 影响范围：`driver/windows/*`
- 实施要点：新增 INF 模板、构建/安装脚本占位、签名与测试模式说明。
- 验收标准：目录结构完整，文档可指导后续驱动实现。
- 验证方法：脚本静态检查。
- 回滚方式：移除新增目录。

### 9. SysVAD 接入工程化脚本

- 任务目标：把 SysVAD 派生接入步骤脚本化，减少人工漏项。
- 影响范围：`driver/windows/scripts/*`、`driver/windows/docs/*`
- 实施要点：新增工具链检查、源码准备、派生参数落板、构建与安装流程文档。
- 验收标准：脚本可执行且输出明确下一步指引。
- 验证方法：脚本静态检查 + 文档走查。
- 回滚方式：移除新增脚本与文档。

## 增量执行进度（2026-02-11）

- [x] 7. 方案 A 决策落板与状态修正（新增端点真实检测 + 状态文案）
- [x] 8. Windows 驱动工程骨架增强
- [x] 9. SysVAD 接入工程化脚本

## 继续实现进展（2026-02-11 第二轮）

- 已实现鼠标全局 Hook（`WH_MOUSE_LL`）并接入快捷键系统：
  - 支持 `MouseLeft/MouseRight/MouseMiddle/MouseBack/MouseForward`
  - 支持与 `Ctrl/Alt/Shift/Super` 组合
  - PTT 模式：按下开麦、释放闭麦
  - Toggle/Hybrid：按下切换状态
- 已改为“输入框点击即录入”交互（无独立“按键录入”按钮）：
  - 聚焦输入框显示 `Press key...`
  - 首次点击不误触发鼠标录入（180ms 防抖）
- 已移除顶部标题卡片与“保存配置/刷新/重初始化按钮”交互，配置改为自动保存并自动应用。
- 已在后端提供驱动可用性细分诊断：
  - 录制端点真实检测（是否出现 `Windows Mic Ctrl Virtual Mic`）
  - 驱动服务状态检测（未安装/已安装未运行/运行中/未知）
  - Test Mode 检测（`bcdedit`）
- 已把初始化失败写入运行状态，避免“假就绪”误判。
- 已同步驱动文档，明确 Windows 实机完成路径与验证步骤。

### 当前阻断（仍需 Windows 驱动开发环境）

1. SysVAD 派生代码改造尚未完成（仅有脚本与流程骨架）。
2. 真实内核端点与用户态 IOCTL 音频注入链路尚未落地。
3. 因当前环境非 Windows + WDK，无法在本机完成驱动编译/安装验收。

## 继续实现进展（2026-02-11 第三轮）

- 已新增构建前驱动产物打包脚本：`scripts/stage-driver-assets.mjs`。
- 发布构建命令新增：`npm run build:release`，在 `tauri build` 前强制校验并拷贝 `.sys/.inf/.cat`。
- 已配置 Tauri `bundle.resources`，驱动产物会进入安装包资源。
- 已更新 GitHub Release 工作流，发布时额外产出并上传 `windows-driver-package.zip`（离线驱动包）。

### 影响与边界

1. 若缺少驱动产物（`.sys/.inf/.cat`），`build:release` 会显式失败，避免发布“无驱动包”的安装器。
2. 当前仍未在安装器内自动执行驱动安装（仅完成离线分发与打包）；安装动作由管理员脚本完成。
- 发布流水线已调整为“驱动产物感知”模式：
  - 有完整 `.sys/.inf/.cat` 时执行 `build:release` 并附带驱动离线包；
  - 无驱动产物时降级为应用安装包构建，避免发布流程硬失败。

## 继续实现进展（2026-02-11 第四轮）

- 应用启动流程已接入“每次启动自动检查并安装驱动”：
  - 若未检测到虚拟麦录制端点，自动从安装包资源定位 INF；
  - 自动触发 `pnputil` 安装（UAC）；
  - 安装后自动轮询端点是否出现。
- Release workflow 已新增驱动构建步骤（best effort）：
  - `check-toolchain` -> `prepare-sysvad` -> `apply-porting-overrides` -> `build-driver`。

### 本轮补齐（2026-02-11 第五轮）

- [x] 强化 `prepare-sysvad.ps1`：同时写入两条 WIL 路径（`driver/windows/src/upstream/wil` 与 `driver/windows/src/wil`），修复 APO 项目相对 include 查找失败。
- [x] 重写 `build-driver.ps1`：
  - 固定输出目标 INF 文件名 `windows-mic-ctrl-virtual-mic.inf`
  - 从可用 `.sys` + 指定 INF 生成 catalog（Inf2Cat）
  - 产物完整性（`.sys/.inf/.cat`）强校验
- [x] 发布工作流改为“驱动必需”：若驱动不完整则直接失败，不再降级发布“无驱动安装包”。

### 仍需完成（Windows 实机）

1. SysVAD 派生源码最终产品化改造（目前仍为样例工程+流程骨架）。
2. 正式签名链（EV/WHQL 或企业签名）。
3. Windows 实机验收并固化报告（首启 UAC -> 端点出现 -> QQ 语音可用）。

## 继续实现进展（2026-02-11 第六轮）

- [x] 修复 INF 模板签名可用性：补齐 `SourceDisksNames/SourceDisksFiles/DestinationDirs`，避免 `Inf2Cat` 22.9.10。
- [x] 修复 `DriverVer` 未来日期问题，避免 `Inf2Cat` 22.9.7。
- [x] 版本提升到 `0.2.4` 并准备重发 Release 验证 CI。
