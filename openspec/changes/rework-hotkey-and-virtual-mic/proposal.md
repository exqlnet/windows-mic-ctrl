# 变更提案：rework-hotkey-and-virtual-mic

## 背景与动机

用户反馈当前版本存在以下问题：

1. 快捷键配置通过字符串输入，易错且体验差。
2. 启动后需手动点“启动桥接”，与“开箱即用”预期不符。
3. UI 中“立即开麦/立即闭麦”语义不清晰。
4. 关键诉求变更：不接受外部桥接链路，要求应用自身提供虚拟麦克风。

## 与现有规范/实现冲突说明

当前已实现方案基于“外部虚拟声卡桥接”，与本次“应用自身创建虚拟麦克风”存在**明确冲突**。

- 冲突点 A：当前方案是用户态桥接，不包含内核态虚拟音频驱动。
- 冲突点 B：当前 UI 暴露“输入设备 + 输出设备（桥接端）”双选择，不符合“仅选择物理输入设备”。

## 目标与范围（本次希望达成）

- 将快捷键改为“按键录入控件”（按下组合键即捕获，而非字符串手填）。
- 应用启动后自动初始化语音链路，若环境满足则自动可用。
- UI 仅保留“物理麦克风输入设备”选择；虚拟麦输出端由系统内部固定。
- 将“立即开麦/立即闭麦”替换为可理解的门控状态与模式文案。
- 应用自身提供可被 QQ 识别的虚拟麦克风设备。

## 非目标

- 不做云端能力。
- 不做降噪/AEC/AGC。
- 不做多路混音。

## 方案选项（阻断级）

### 方案 A（推荐，满足你的硬要求）：自研虚拟麦克风驱动 + 用户态控制服务

#### 架构

- 内核态：Windows 虚拟音频驱动（参考 SysVAD 思路，输出 Capture Endpoint 给 QQ）。
- 用户态：Rust 音频采集与门控服务（物理麦输入 -> 驱动共享缓冲/IOCTL）。
- 前端：Tauri UI 配置快捷键、输入设备、状态与诊断。

#### 关键实现点

- 驱动签名与安装：需有效签名链（发布环境通常要求 EV/WHQL 流程）。
- 安装器升级：MSI/NSIS 需集成驱动安装、升级与卸载顺序。
- 可靠性：驱动崩溃隔离、服务自动重连、回滚到“静音失败安全态”。

#### 风险

- 开发与维护复杂度高，周期显著上升。
- 驱动签名/系统策略不满足会导致最终不可安装。

### 方案 B（不满足你“不要桥接”的硬要求，仅作为兜底）：继续外部虚拟声卡，强化自动化体验

- 保留外部虚拟声卡依赖。
- 启动即自动初始化、隐藏桥接细节、仅暴露物理输入设备选择。
- 快捷键改按键录入。

> 该方案能快速稳定交付，但不满足“应用自身创建虚拟麦克风”的核心要求。

## 安全/权限/隐私

- 默认本地处理音频，不上传。
- 若采用方案 A，新增内核驱动安装权限与签名链风险。
- 默认失败策略：显式失败 + 清晰提示 + 结构化日志。

## 性能/容量

- 目标维持端到端附加延迟 < 60ms。
- 驱动 + 用户态链路需避免额外重采样与大缓冲。

## 兼容性与回滚

- 配置结构向后兼容。
- 方案 A 需要额外定义“驱动版本回滚”流程（卸载/回退包）。

## 决策记录（Decisions）

- 默认选择更保守的失败策略：无法初始化虚拟麦时不进入“假成功”。
- 默认日志结构化，保留快捷键变更、驱动状态、设备状态字段。
- 默认保留托盘入口，但文案统一为“状态/模式”，不再使用“立即开麦/闭麦”术语。

## 澄清问题清单

### 阻断级（必须先确认）

1. 你是否确认选择**方案 A（自研虚拟麦驱动）**？
2. 是否具备驱动签名发布条件（证书/签名流程）？若无，是否接受开发期测试签名模式？
3. 首版是否接受“仅 Windows 10/11 + 需管理员安装驱动”的限制？

### 非阻断级（默认决策）

1. 快捷键默认值：`Ctrl+Shift+V`（默认保留，用户可录入覆盖）。
2. 启动行为：默认“启动即自动初始化”，失败时在托盘与主界面显示错误。
3. UI 文案默认：
   - “当前状态：开麦/闭麦”
   - “模式：按住说话/切换开关”

## 实施阶段结论（2026-02-10）

- 用户已批准进入实现阶段。
- 本轮已完成：
  - 快捷键改为按键录入。
  - 启动自动初始化语音链路。
  - 主界面简化为仅选择物理麦克风输入。
  - “立即开麦/立即闭麦”文案替换为“当前状态：开麦/闭麦”。
  - 新增 `driver/` 驱动工程骨架与协议草案文档。
- 本轮未完成（阻断）：
  - 真实内核虚拟麦端点（可被 QQ 直接识别）尚未实现。
  - 驱动签名与安装链路未落地。
- 阶段化决策：
  - 继续保留兼容可用路径（外部虚拟声卡）确保当前版本可运行。
  - 并行推进驱动工程骨架，后续迭代替换为自建虚拟麦后端。
