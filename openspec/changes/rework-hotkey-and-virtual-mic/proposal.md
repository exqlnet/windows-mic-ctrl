# 变更提案：rework-hotkey-and-virtual-mic

## 背景与动机

用户反馈当前版本存在以下问题：

1. 快捷键配置通过字符串输入，易错且体验差。
2. 启动后需手动点“启动桥接”，与“开箱即用”预期不符。
3. UI 中“立即开麦/立即闭麦”语义不清晰。
4. 关键诉求变更：不接受外部桥接链路，要求应用自身提供虚拟麦克风。

## 与现有规范/实现冲突说明

当前已实现方案基于“外部虚拟声卡桥接”，与本次“应用自身创建虚拟麦克风”存在**明确冲突**。

- 冲突点 A：当前方案是用户态桥接，不包含内核态虚拟音频驱动。
- 冲突点 B：当前 UI 暴露“输入设备 + 输出设备（桥接端）”双选择，不符合“仅选择物理输入设备”。

## 目标与范围（本次希望达成）

- 将快捷键改为“按键录入控件”（按下组合键即捕获，而非字符串手填）。
- 应用启动后自动初始化语音链路，若环境满足则自动可用。
- UI 仅保留“物理麦克风输入设备”选择；虚拟麦输出端由系统内部固定。
- 将“立即开麦/立即闭麦”替换为可理解的门控状态与模式文案。
- 应用自身提供可被 QQ 识别的虚拟麦克风设备。

## 非目标

- 不做云端能力。
- 不做降噪/AEC/AGC。
- 不做多路混音。

## 方案选项（阻断级）

### 方案 A（推荐，满足你的硬要求）：自研虚拟麦克风驱动 + 用户态控制服务

#### 架构

- 内核态：Windows 虚拟音频驱动（参考 SysVAD 思路，输出 Capture Endpoint 给 QQ）。
- 用户态：Rust 音频采集与门控服务（物理麦输入 -> 驱动共享缓冲/IOCTL）。
- 前端：Tauri UI 配置快捷键、输入设备、状态与诊断。

#### 关键实现点

- 驱动签名与安装：需有效签名链（发布环境通常要求 EV/WHQL 流程）。
- 安装器升级：MSI/NSIS 需集成驱动安装、升级与卸载顺序。
- 可靠性：驱动崩溃隔离、服务自动重连、回滚到“静音失败安全态”。

#### 风险

- 开发与维护复杂度高，周期显著上升。
- 驱动签名/系统策略不满足会导致最终不可安装。

### 方案 B（不满足你“不要桥接”的硬要求，仅作为兜底）：继续外部虚拟声卡，强化自动化体验

- 保留外部虚拟声卡依赖。
- 启动即自动初始化、隐藏桥接细节、仅暴露物理输入设备选择。
- 快捷键改按键录入。

> 该方案能快速稳定交付，但不满足“应用自身创建虚拟麦克风”的核心要求。

## 安全/权限/隐私

- 默认本地处理音频，不上传。
- 若采用方案 A，新增内核驱动安装权限与签名链风险。
- 默认失败策略：显式失败 + 清晰提示 + 结构化日志。

## 性能/容量

- 目标维持端到端附加延迟 < 60ms。
- 驱动 + 用户态链路需避免额外重采样与大缓冲。

## 兼容性与回滚

- 配置结构向后兼容。
- 方案 A 需要额外定义“驱动版本回滚”流程（卸载/回退包）。

## 决策记录（Decisions）

- 默认选择更保守的失败策略：无法初始化虚拟麦时不进入“假成功”。
- 默认日志结构化，保留快捷键变更、驱动状态、设备状态字段。
- 默认保留托盘入口，但文案统一为“状态/模式”，不再使用“立即开麦/闭麦”术语。

## 澄清问题清单

### 阻断级（必须先确认）

1. 你是否确认选择**方案 A（自研虚拟麦驱动）**？
2. 是否具备驱动签名发布条件（证书/签名流程）？若无，是否接受开发期测试签名模式？
3. 首版是否接受“仅 Windows 10/11 + 需管理员安装驱动”的限制？

### 非阻断级（默认决策）

1. 快捷键默认值：`Ctrl+Shift+V`（默认保留，用户可录入覆盖）。
2. 启动行为：默认“启动即自动初始化”，失败时在托盘与主界面显示错误。
3. UI 文案默认：
   - “当前状态：开麦/闭麦”
   - “模式：按住说话/切换开关”

## 实施阶段结论（2026-02-10）

- 用户已批准进入实现阶段。
- 本轮已完成：
  - 快捷键改为按键录入。
  - 启动自动初始化语音链路。
  - 主界面简化为仅选择物理麦克风输入。
  - “立即开麦/立即闭麦”文案替换为“当前状态：开麦/闭麦”。
  - 新增 `driver/` 驱动工程骨架与协议草案文档。
- 本轮未完成（阻断）：
  - 真实内核虚拟麦端点（可被 QQ 直接识别）尚未实现。
  - 驱动签名与安装链路未落地。
- 阶段化决策：
  - 继续保留兼容可用路径（外部虚拟声卡）确保当前版本可运行。
  - 并行推进驱动工程骨架，后续迭代替换为自建虚拟麦后端。

## 最新决策更新（2026-02-11）

- 用户已明确确认：选择“应用自身创建虚拟麦克风”路径（即本提案中的方案 A，自研驱动路线）。
- 兼容路径（外部虚拟声卡）仅保留为开发期兜底，不再作为最终交付目标。
- 立即执行目标调整：
  1. 修正 UI/状态中对“虚拟麦已就绪”的误导展示。
  2. 增加“真实虚拟麦端点检测”能力（基于系统录制设备枚举）。
  3. 新增 Windows 驱动工程化骨架（INF/安装脚本/产物目录约定），为可安装驱动落地做准备。

- 2026-02-11 增量执行：新增 SysVAD 接入工程化脚本（工具链检查/源码准备/派生参数落板/构建安装流程文档），用于推进真实驱动端点落地。

## 继续实现进展（2026-02-11 第二轮）

- 已新增驱动一键准备脚本：`driver/windows/scripts/dev-bootstrap.ps1`。
- 已增强应用内驱动诊断：
  - 录制端点检测（是否出现 `Windows Mic Ctrl Virtual Mic`）
  - 驱动服务状态检测（未安装/已安装未运行/运行中/未知）
  - Test Mode 检测（`bcdedit`）
- 已把初始化失败写入运行状态，避免“假就绪”误判。
- 已同步驱动文档，明确 Windows 实机完成路径与验证步骤。

### 当前阻断（仍需 Windows 驱动开发环境）

1. SysVAD 派生代码改造尚未完成（仅有脚本与流程骨架）。
2. 真实内核端点与用户态 IOCTL 音频注入链路尚未落地。
3. 因当前环境非 Windows + WDK，无法在本机完成驱动编译/安装验收。

## 继续实现进展（2026-02-11 第三轮）

- 已新增构建前驱动产物打包脚本：`scripts/stage-driver-assets.mjs`。
- 发布构建命令新增：`npm run build:release`，在 `tauri build` 前强制校验并拷贝 `.sys/.inf/.cat`。
- 已配置 Tauri `bundle.resources`，驱动产物会进入安装包资源。
- 已更新 GitHub Release 工作流，发布时额外产出并上传 `windows-driver-package.zip`（离线驱动包）。

### 影响与边界

1. 若缺少驱动产物（`.sys/.inf/.cat`），`build:release` 会显式失败，避免发布“无驱动包”的安装器。
2. 当前仍未在安装器内自动执行驱动安装（仅完成离线分发与打包）；安装动作由管理员脚本完成。
- 发布流水线已调整为“驱动产物感知”模式：
  - 有完整 `.sys/.inf/.cat` 时执行 `build:release` 并附带驱动离线包；
  - 无驱动产物时降级为应用安装包构建，避免发布流程硬失败。
