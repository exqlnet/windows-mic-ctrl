# 任务拆解：rework-hotkey-and-virtual-mic

## 0. 先决任务（阻断）

- 任务目标：锁定方案 A/B 与签名能力边界。
- 影响范围：`openspec/changes/rework-hotkey-and-virtual-mic/*`
- 实施要点：明确是否进入驱动开发路径。
- 验收标准：阻断问题全部闭合并记录到 proposal 决策区。
- 验证方法：评审记录。
- 回滚方式：停留在规范阶段，不进入实现。

## 1. 快捷键录入改造（UI + 后端）

- 任务目标：将字符串输入改为按键录入捕获。
- 影响范围：`src/App.tsx`、`src/components/*`、`src-tauri/src/hotkey.rs`
- 实施要点：键盘事件录入、冲突提示、注册回滚。
- 验收标准：用户可按下组合键完成录入并生效。
- 验证方法：手动场景 + 单测。
- 回滚方式：回退到字符串输入。

## 2. 启动自动初始化与状态提示

- 任务目标：应用启动后自动初始化语音链路与状态。
- 影响范围：`src-tauri/src/lib.rs`、`src-tauri/src/app_state.rs`、`src/App.tsx`
- 实施要点：冷启动检测、失败显式提示、托盘状态同步。
- 验收标准：首次启动无需手动点“启动”即可进入可用/可诊断状态。
- 验证方法：冷启动回归、日志检查。
- 回滚方式：恢复手动启动开关。

## 3. UI 简化与文案调整

- 任务目标：仅保留物理麦输入选择，移除“立即开麦/闭麦”文案。
- 影响范围：`src/App.tsx`、`src/lib/types.ts`
- 实施要点：保留模式切换与状态展示，移除桥接输出选择 UI。
- 验收标准：页面中不出现桥接输出配置与“立即开麦/闭麦”文案。
- 验证方法：界面走查与快照。
- 回滚方式：恢复双设备配置界面。

## 4A.（方案 A）虚拟麦驱动与用户态服务

- 任务目标：应用自身提供可识别的虚拟麦克风端点。
- 影响范围：`driver/*`（新目录）、`src-tauri/src/audio/*`、安装脚本
- 实施要点：
  - 驱动端点暴露（Capture Endpoint）
  - 用户态音频写入接口（共享内存/IOCTL）
  - 门控状态映射
- 验收标准：QQ 可直接选择“本应用虚拟麦克风”。
- 验证方法：Windows 实机验收 + 稳定性测试。
- 回滚方式：卸载驱动并恢复旧版本。

## 4B.（方案 B）外部虚拟声卡兼容路径（仅兜底）

- 任务目标：若 A 被否决/受阻，提供快速可用版本。
- 影响范围：现有 `audio.rs` 与 UI 简化改造。
- 实施要点：保留桥接内核，但隐藏输出配置细节。
- 验收标准：用户仅选物理输入也可工作。
- 验证方法：QQ 语音实测。
- 回滚方式：恢复当前版本。

## 5. 发布与回滚策略补充

- 任务目标：完善驱动或发布流程相关文档与回滚手册。
- 影响范围：`README.md`、`docs/*`（如新增）
- 实施要点：写清管理员权限、签名要求、卸载步骤。
- 验收标准：按文档可完成安装、升级、回滚。
- 验证方法：文档走查 + 一次演练。
- 回滚方式：恢复前版文档。


## 6. 可观测性与故障诊断

- 任务目标：补齐驱动态/用户态链路的日志与健康指标。
- 影响范围：`src-tauri/src/*`、`driver/*`（若采用方案 A）
- 实施要点：统一请求/会话 ID、初始化耗时、设备状态、错误码映射。
- 验收标准：出现初始化失败、驱动异常、快捷键冲突时可快速定位。
- 验证方法：注入故障演练（设备断开、驱动不可用、按键冲突）。
- 回滚方式：仅降低日志级别，不影响主流程。

## 实施进度（2026-02-10）

- [x] 1. 快捷键录入改造（UI + 后端）
- [x] 2. 启动自动初始化与状态提示
- [x] 3. UI 简化与文案调整
- [x] 4A. 虚拟麦驱动与用户态服务（已完成工程骨架与协议草案）
- [ ] 4A. 虚拟麦驱动与用户态服务（真实可识别端点实现）
- [ ] 5. 发布与回滚策略补充
- [ ] 6. 可观测性与故障诊断（驱动态专项）
